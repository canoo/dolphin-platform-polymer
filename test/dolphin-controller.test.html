<script src="../bower_components/webcomponentsjs/webcomponents-loader.js"></script>
<script src="../bower_components/web-component-tester/browser.js"></script>
<link rel="import" href="../dolphin-controller.html">

<test-fixture id="simple-controller">
  <template>
    <dolphin-controller name="SimpleController"></dolphin-controller>
  </template>
</test-fixture>

<test-fixture id="simple-auto-controller">
  <template>
    <dolphin-controller name="SimpleController" auto></dolphin-controller>
  </template>
</test-fixture>

<script>
  suite("<dolphin-controller>", () => {

    setup(() => {
      const clientContext = {
        beanManager: {
          onBeanUpdate: (callback) => { },
          onArrayUpdate: (callback) => { },
          notifyBeanChange: () => { },
          notifyArrayChange: () => { },
        },
        createController: (name) => {
          let onDestroyedCallback
          return Promise.resolve({
            model: {},
            destroy: () => {
              if (onDestroyedCallback) {
                onDestroyedCallback()
              }
            },
            onDestroyed: (callback) => {
              onDestroyedCallback = callback
            }
          })
        }
      }
      window.clientContext = clientContext
    })

    test("create controller", done => {
      // given:
      const controller = fixture("simple-controller")

      // when:
      controller.create()
      expect(controller.state).to.equal("INITIALIZING")

      // then:
      flush(() => {
        expect(controller.state).to.equal("READY")
        done()
      })
    })

    test("destroy controller", done => {
      // given:
      const controller = fixture("simple-controller")
      controller.create()

      // when:
      flush(() => {
        controller.destroy()

        // then:
        expect(controller.state).to.equal("DESTROYED")
        done()
      })
    })

    test("auto create controller", done => {
      // when:
      const controller = fixture("simple-auto-controller")
      expect(controller.state).to.equal("INITIALIZING")

      // then:
      flush(() => {
        expect(controller.state).to.equal("READY")
        done()
      })
    })

    test("auto destroy controller", done => {
      // given:
      const controller = fixture("simple-auto-controller")

      flush(() => {
        // when:
        controller.remove()

        // then:
        expect(controller.state).to.equal("DESTROYED")
        done()
      })
    })

    test("change controller model", done => {
      // given:
      const controller = fixture("simple-controller")
      controller.create()

      // when:
      controller.set("model", { bean: "foo" })
      controller.set("model.bean", "bar")
      controller.set("model.array", [])
      controller.set("model.array", [1, 2, 3, 4, 5])
      controller.splice("model.array", 1, 3, ...[8, 9])

      // then:
      flush(() => {
        expect(controller.model).to.deep.equal({ array: [1, 8, 9, 5], bean: "bar" })
        done()
      })
    })

  })
</script>