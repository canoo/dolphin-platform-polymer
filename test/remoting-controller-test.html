<!doctype html>
<html>
<head>
  <meta charset="utf-8">

  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../dolphin-platform-js/dist/dolphin-platform.js"></script>
  <script src="../../test-fixture/test-fixture-mocha.js"></script>

  <link rel="import" href="../remoting-controller.html">
  

</head>
<body>

    <test-fixture id="rc">
        <template>
            <remoting-controller id="controller" name="TestController"></remoting-controller>
        </template>
    </test-fixture>

    <test-fixture id="rc-lazy">
            <template>
                <remoting-controller id="controller" name="TestController" not-managed></remoting-controller>
            </template>
        </test-fixture>

    <script>

        suite('<remoting-controller>', function() {

            setup(function() {
                //console.log('setup');
                mockClientContext = {
                    _controller: {
                        model: {},
                        destroy: () => {
                            if (onDestroyedCallback) {
                                onDestroyedCallback()
                            }
                        },
                        onDestroyed: (callback) => {
                            onDestroyedCallback = callback
                        },
                        getId: () => {
                            return 'id';
                        },
                        getModel: () => {
                            return this.model;
                        }
                    },
                    beanManager: {
                        onBeanUpdate: () => null,
                        onArrayUpdate: () => null,
                        notifyBeanChange: () => null,
                        notifyArrayChange: () => null,
                        onAdded: () => null,
                        onRemoved: () => null,
                        onBeanUpdate: () => null,
                        onArrayUpdate: () => null
                    },
                    createController: (name) => {
                        return Promise.resolve(clientContext._controller)
                    }
                }
            });

            teardown(function() {
                //console.log('teardown');
                currentComponent = null;
                mockClientContext = null;
                delete window.clientContext;
            });

            test('correct initialization', function(done) {
                const createControllerSpy = sinon.spy(mockClientContext, "createController");
                window.clientContext = mockClientContext;

                currentComponent = fixture('rc');
                sinon.assert.calledOnce(createControllerSpy);
                sinon.assert.calledWith(createControllerSpy, 'TestController');

                done();
            });

            test('cannot initialize without client context', function(done) {
                const RemotingController = customElements.get('remoting-controller');
                const controllerElement = new RemotingController();

                let expectErrorMessage = function(message) {
                    console.log(message);
                    let errorText = 'Client context not found';
                    let correctErrorFound = message.indexOf(errorText) >= 0;
                    expect(correctErrorFound).to.be.equal(true);
                    done();
                }
                
                window._onerror = window.onerror;
                window.onerror = function(message) {
                    // Chrome+Safari
                    window.onerror = window._onerror;
                    expectErrorMessage(message);
                }

                try {
                    document.body.appendChild(controllerElement);
                } catch (error) {
                    // Firefox
                    expectErrorMessage(error);
                }

            });

            test('lazy initialization, without create()', function(done) {
                const createControllerSpy = sinon.spy(mockClientContext, "createController");
                window.clientContext = mockClientContext;

                currentComponent = fixture('rc-lazy');
                sinon.assert.notCalled(createControllerSpy);

                done();
            });

            test('lazy initialization, with create() and destroy()', function(done) {
                const createControllerSpy = sinon.spy(mockClientContext, "createController");
                const destroySpy = sinon.spy(mockClientContext._controller, "destroy");
                window.clientContext = mockClientContext;

                currentComponent = fixture('rc-lazy');
                currentComponent.create().then(function() {

                    currentComponent.destroy().then(function() {

                        sinon.assert.calledOnce(createControllerSpy);
                        sinon.assert.calledOnce(destroySpy);

                        done();
                    });

                    
                });
                            
            });

            test('lazy initialization, destroy() without create()', function(done) {
                const createControllerSpy = sinon.spy(mockClientContext, "createController");
                const destroySpy = sinon.spy(mockClientContext._controller, "destroy");
                window.clientContext = mockClientContext;

                currentComponent = fixture('rc-lazy');
                try {
                    currentComponent.destroy().catch(function() {

                        sinon.assert.notCalled(destroySpy);

                        done();
                    });
                } catch (error) {
                    done();
                }
                            
            });

            test('postconstruct event', function(done) {
                const RemotingController = customElements.get('remoting-controller');
                const controllerElement = new RemotingController();

                window.clientContext = mockClientContext;
                let eventCallback = function() {
                    done();
                };
                controllerElement.addEventListener('postconstruct', eventCallback);

                document.body.appendChild(controllerElement);

            });

            test('postdestroyed event', function(done) {
                const RemotingController = customElements.get('remoting-controller');
                const controllerElement = new RemotingController();

                window.clientContext = mockClientContext;
                let addedCallback = function() {
                    document.body.removeChild(controllerElement);
                };
                let eventCallback = function() {
                    done();
                };
                controllerElement.addEventListener('postconstruct', addedCallback);
                controllerElement.addEventListener('postdestroyed', eventCallback);

                document.body.appendChild(controllerElement);
            });

            test('correct name property', function(done) {
                window.clientContext = mockClientContext;

                currentComponent = fixture('rc');
                expect(currentComponent.name).to.be.equal('TestController');

                done();
            });


        });

    </script>

</body>
</html>