<!doctype html>
<html>
<head>
  <meta charset="utf-8">

  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../dolphin-platform-js/dist/dolphin-platform.js"></script>

  <link rel="import" href="../remoting-controller.html">
  <script src="../../test-fixture/test-fixture-mocha.js"></script>

</head>
<body>

    <test-fixture id="rc">
        <template>
            <remoting-controller id="controller" name="TestController"></remoting-controller>
        </template>
    </test-fixture>

    <script>

        suite('<remoting-controller>', function() {

            setup(function() {
                //console.log('setup');
                mockClientContext = {
                    _controller: {
                        model: {},
                        destroy: () => {
                            if (onDestroyedCallback) {
                                onDestroyedCallback()
                            }
                        },
                        onDestroyed: (callback) => {
                            onDestroyedCallback = callback
                        },
                        getId: () => {
                            return 'id';
                        },
                        getModel: () => {
                            return this.model;
                        }
                    },
                    beanManager: {
                        onBeanUpdate: () => null,
                        onArrayUpdate: () => null,
                        notifyBeanChange: () => null,
                        notifyArrayChange: () => null,
                        onAdded: () => null,
                        onRemoved: () => null,
                        onBeanUpdate: () => null,
                        onArrayUpdate: () => null
                    },
                    createController: (name) => {
                        return Promise.resolve(clientContext._controller)
                    }
                }
            });

            teardown(function() {
                //console.log('teardown');
                rc = null;
                mockClientContext = null;
                delete window.clientContext;
            });

            test('correct initialization', function(done) {
                const createControllerSpy = sinon.spy(mockClientContext, "createController");
                window.clientContext = mockClientContext;

                rc = fixture('rc');
                expect(rc.name).to.be.equal('TestController');
                sinon.assert.calledOnce(createControllerSpy);
                sinon.assert.calledWith(createControllerSpy, 'TestController');

                done();
            });

            test('cannot initialize without client context', function(done) {
                const RemotingController = customElements.get('remoting-controller');
                const controllerElement = new RemotingController();

                let expectErrorMessage = function(message) {
                    let errorText = 'Cannot create Dolphin Controller.';
                    let correctErrorFound = message.indexOf(errorText) >= 0;
                    expect(correctErrorFound).to.be.equal(true);
                    done();
                }
                
                window._onerror = window.onerror;
                window.onerror = function(message) {
                    // Chrome+Safari
                    window.onerror = window._onerror;
                    expectErrorMessage(message);
                }

                try {
                    document.body.appendChild(controllerElement);
                } catch (error) {
                    // Firefox
                    expectErrorMessage(error);
                }

            });

        });

    </script>

</body>
</html>