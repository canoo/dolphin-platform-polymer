<link rel="import" href="./bower_components/polymer/polymer-element.html">

<dom-module id="dolphin-controller">
  <script>
    function isNil(value) {
      return value === null || value === undefined
    }

    class DolphinController extends Polymer.Element {
      static get is() {
        return "dolphin-controller"
      }

      static get properties() {
        return {
          dolphinContext: Object,
          name: String,
          state: String,
          model: Object
        }
      }

      static get observers() {
        return [
          "_onDolphinContextChanged(dolphinContext)",
          "_onModelChanged(model.*)"
        ]
      }

      _onDolphinContextChanged() {
        if (!isNil(this.dolphinContext)) {
          this.beanManager = this.dolphinContext.beanManager
          this.beanManager.onBeanUpdate(this._onDolphinBeanUpdated.bind(this))
          this.beanManager.onArrayUpdate(this._onDolphinBeanArrayUpdated.bind(this))
        }
      }

      create() {
        if (!isNil(this.dolphinContext) && !isNil(this.name)) {
          this._onControllerInitializing()
          this.dolphinContext.createController(this.name)
            .then(controller => {
              this._onControllerReady(controller)
              controller.onDestroyed(() => {
                this._onControllerDestroyed(controller)
              })
            })
        }
      }

      destroy() {
        if (!isNil(this.controller)) {
          this.controller.destroy()
        }
      }

      _onControllerInitializing() {
        console.log("_onControllerInitializing()", this.name)
        this.controller = null
        this.state = "INITIALIZING"
      }

      _onControllerReady(controller) {
        console.log("_onControllerReady()", this.name, controller)
        this.controller = controller
        this.state = "READY"
      }

      _onControllerDestroyed(controller) {
        console.log("_onControllerDestroyed()", this.name, controller)
        this.controller = null
        this.state = "DESTROYED"
      }

      _onModelChanged(event) {
        const propertyPath = event.path
        const newValue = event.value
        if (!isNil(newValue) && !isNil(newValue.indexSplices)) {
          this._onModelBeanArrayChanged(propertyPath, newValue)
        }
        else {
          this._onModelBeanChanged(propertyPath, newValue)
        }
      }

      _onModelBeanChanged(propertyPath, newValue) {
        console.log("on model bean changed:", propertyPath, newValue)
      }

      _onModelBeanArrayChanged(propertyPath, newValue) {
        console.log("on model bean array changed:", propertyPath, newValue)
      }

      _onDolphinBeanUpdated(bean, propertyName, newValue, oldValue) {
        console.log("on dolphin bean updated:", bean, propertyName, newValue, oldValue)
      }

      _onDolphinBeanArrayUpdated(bean, propertyName, startIndex, removedCount, addedItems) {
        console.log("on dolphin bean array updated:", bean, propertyName, startIndex, removedCount, addedItems)
      }
    }

    window.customElements.define(DolphinController.is, DolphinController)
  </script>
</dom-module>