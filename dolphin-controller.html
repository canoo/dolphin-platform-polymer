<link rel="import" href="./bower_components/polymer/polymer-element.html">

<dom-module id="dolphin-controller">
  <script>
    class DolphinController extends Polymer.Element {
      static get is() {
        return "dolphin-controller"
      }

      static get properties() {
        return {
          clientContext: {
            type: Object,
            value: () => window.clientContext
          },
          name: String,
          state: String,
          model: Object,
          auto: {
            type: Boolean,
            value: false
          }
        }
      }

      static get observers() {
        return [
          "_onClientContextChanged(clientContext)",
          "_onModelChanged(model.*)"
        ]
      }

      connectedCallback() {
        super.connectedCallback()
        if (!!this.auto) {
          this.create()
        }
      }

      disconnectedCallback() {
        super.disconnectedCallback()
        if (!!this.auto) {
          this.destroy()
        }
      }

      create() {
        if (!isNil(this.clientContext) && !isNil(this.name)) {
          this._onControllerInitializing()
          this.clientContext.createController(this.name)
            .then(controller => {
              this._onControllerReady(controller)
              controller.onDestroyed(() => {
                this._onControllerDestroyed(controller)
              })
            })
        }
      }

      destroy() {
        if (!isNil(this._controller)) {
          this._controller.destroy()
        }
      }

      _onClientContextChanged() {
        if (!isNil(this.clientContext)) {
          this.beanManager = this.clientContext.beanManager
          this.beanManager.onBeanUpdate(this._onReceiveDolphinBeanUpdate.bind(this))
          this.beanManager.onArrayUpdate(this._onReceiveDolphinBeanArrayUpdate.bind(this))
        }
      }

      _onControllerInitializing() {
        console.log("_onControllerInitializing()", this.name)
        this._controller = null
        this.state = "INITIALIZING"
      }

      _onControllerReady(controller) {
        console.log("_onControllerReady()", this.name, controller)
        this._controller = controller
        this.state = "READY"
      }

      _onControllerDestroyed(controller) {
        console.log("_onControllerDestroyed()", this.name, controller)
        this._controller = null
        this.state = "DESTROYED"
      }

      _onModelChanged(event) {
        const propertyPath = event.path
        const newValue = event.value
        if (!isNil(newValue) && !isNil(newValue.indexSplices)) {
          this._onModelBeanArrayChanged(propertyPath, newValue)
        }
        else {
          this._onModelBeanChanged(propertyPath, newValue)
        }
      }

      _onModelBeanChanged(propertyPath, newValue) {
        console.log("on model bean changed:", propertyPath, newValue)
      }

      _onModelBeanArrayChanged(propertyPath, newValue) {
        console.log("on model bean array changed:", propertyPath, newValue)
      }

      _onReceiveDolphinBeanUpdate(bean, propertyName, newValue, oldValue) {
        console.log("on receive dolphin bean:", bean, propertyName, newValue, oldValue)
      }

      _onReceiveDolphinBeanArrayUpdate(bean, propertyName, startIndex, removedCount, addedItems) {
        console.log("on receive dolphin bean array:", bean, propertyName, startIndex, removedCount, addedItems)
      }
    }

    window.customElements.define(DolphinController.is, DolphinController)

    function isNil(value) {
      return value === null || value === undefined
    }
  </script>
</dom-module>